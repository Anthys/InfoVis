<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <style type="text/css" media="screen, print"></style>
    <title>Co2 Greenhouse Gas Emissions</title>
  </head>

  <body>
    <script
      type="text/javascript"
      src="https://www.gstatic.com/charts/loader.js"
    ></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!--TODO REPLACE BY LOCAL D3-->
    <fieldset style="width: 285px; z-index: 1; position: absolute; left:50px;">
      <legend>Select map attribute :</legend>

      <div>
        <input type="radio" id="co2" name="co2_types" value="co2" />
        <label for="co2">Co2 emissions</label>
      </div>

      <div>
        <input
          type="radio"
          id="co2_per_capita"
          name="co2_types"
          value="co2_per_capita"
          checked
        />
        <label for="co2_per_capita">Co2 emissions per capita</label>
      </div>

      <div>
        <input
          type="radio"
          id="co2_per_gdp"
          name="co2_types"
          value="co2_per_gdp"
        />
        <label for="co2_per_gdp">Co2 emissions per gdp</label>
      </div>
    </fieldset>
    <div
      id="regions_div"
      style="width: 1300px; height: 600px; margin: 50px"
    ></div>
    <script>
      // defining variables
      let parseDate = d3.timeParse("%Y");

      var margin = { top: 50, right: 50, bottom: 50, left: 50 },
        width = 1300 - margin.left - margin.right,
        height = 800 - margin.top - margin.bottom;

      var svg = d3.select("body").append("svg");

      var plot = svg
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      var t = d3.scaleTime().range([0, width]);

      let loadedData,
        years,
        currentYear = new Date("2018");

      // Loading google charts for map drawing
      google.charts.load("current", {
        packages: ["geochart"],
      });
      google.charts.setOnLoadCallback(loadData);

      // Data management functions -------------------------------------

      // Data based on selected main attribute for map
      function getDataOfMainAttributeForMap(data) {
        const type = document.querySelector(
          'input[name="co2_types"]:checked'
        ).value;
        switch (type) {
          case "co2":
            data = data.map((d) => [d.country, d.co2]);
            data = [["Country", "co2Emission (million ton)"]].concat(data);
            break;
          case "co2_per_gdp":
            data = data.map((d) => [d.country, d.co2_per_gdp]);
            data = [["Country", "co2Emission/gdp (kg/dollar)"]].concat(data);
            break;
          default: // co2 per capita
            data = data.map((d) => [d.country, d.co2_per_capita]);
            data = [["Country", "co2Emission/capita (ton/hab)"]].concat(data);
            break;
        }
        return data;
      }

      // default, first load
      function loadData() {
        d3.tsv("/course_files/data/owid-co2-data.tsv")
          .row((d) => ({
            country: d["#country"],
            iso3: d.iso_code,
            co2: +d.co2,
            trade_co2: +d.trade_co2,
            co2_per_capita: +d.co2_per_capita,
            co2_per_gdp: +d.co2_per_gdp,
            year: +d.year,
            population: +d.population,
          }))
          .get(function (data) {
            // data
            loadedData = data;
            years = [...new Set(data.map((d) => d.year))]
              .map((d) => new Date(`${d}`))
              .sort((a, b) => a - b);

            t.domain([d3.min(years), d3.max(years)]);

            const [t0, t1] = t.domain();
            data = data.filter((d) => {
              return d.year == currentYear;
            });
            data = getDataOfMainAttributeForMap(data);

            // draw map
            drawRegionsMap(data);

            // draw year slider
            drawYearSlider(years);
          });
      }

      // Data filtering by observation year
      function filterData(year) {
        currentYear = year;
        let data = loadedData.filter((d) => {
          return d.year == year;
        });
        data = getDataOfMainAttributeForMap(data);

        // draw map
        drawRegionsMap(data);
      }

      // Map drawing -------------------------------------
      function getMaxValueForMap() {
        const type = document.querySelector(
          'input[name="co2_types"]:checked'
        ).value;
        switch (type) {
          case "co2":
            if (currentYear >= 2010) return 8000;
            else return 4000;
          case "co2_per_gdp":
            return 1.25;
          default: // co2 per capita
            return 27;
        }
      }

      function drawRegionsMap(data) {
        let chartData = google.visualization.arrayToDataTable(data);
        var options = {
          colorAxis: { minValue: 0, maxValue: getMaxValueForMap() },
        };

        var chart = new google.visualization.GeoChart(
          document.getElementById("regions_div")
        );

        chart.draw(chartData, options);
      }

      // Years' slider -------------------------------------
      function drawYearSlider(years) {
        // year slider
        var t_slider = plot.append("g");
        t_slider.call(d3.axisBottom().scale(t).tickFormat(d3.timeFormat("%Y")));
        function clickable(elem) {
          return elem
            .on("mouseover", (e) => elem.style("cursor", "pointer"))
            .on("mouseout", (e) => elem.style("cursor", "default"));
        }

        const t_thumb = clickable(t_slider.append("g"));

        t_thumb.append("line").attr("stroke", "black").attr("y2", "-10");
        t_thumb
          .append("circle")
          .attr("stroke", "black")
          .attr("fill", "lightgray")
          .attr("r", "5");
        t_thumb
          .append("rect")
          .attr("fill", "white")
          .attr("fill-opacity", ".75")
          .attr("x", "-13")
          .attr("width", "26")
          .attr("y", "-22")
          .attr("height", "12");
        t_thumb
          .append("text")
          .attr("fill", "black")
          .attr("y", "-12")
          .attr("text-anchor", "middle")
          .text("â€¦");
        var t_x = 0;
        t_thumb.call(
          d3
            .drag()
            .on("start", () => {
              t_x = d3.event.x;
            })
            .on("drag", () => {
              t_x += d3.event.dx;
              if (t_x < margin.left) {
                t_x = 0;
              } else if (t_x > width) {
                t_x = width;
              }
              year = t.invert(t_x);
              updateYear(year);
            })
        );

        function updateYear(year) {
          // on slider
          t_thumb.attr("transform", `translate(${t(year)})`);
          year = year.getFullYear();
          t_thumb.select("text").text(year);

          // update data on map
          filterData(year);
        }
        updateYear(currentYear);
      }

      // Radio input for co2 types ------------------------------
      var radios = document.querySelectorAll(
        'input[type=radio][name="co2_types"]'
      );
      radios.forEach((radio) =>
        radio.addEventListener("change", () => {
          // trigger change of main attribute
          filterData(currentYear);
        })
      );
    </script>
  </body>
</html>
